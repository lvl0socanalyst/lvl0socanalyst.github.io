---
layout: post
title:  "CrowdStrike PsFalcon Bulk Containment Script"
date:   2025-09-09 21:00:00 +1000
categories: scripts
---

<style>
  body { font-size: 16px; }
  body {font-family: 'Inter', sans-serif}
  h1 { font-size: 19px !important; }
  h2 { font-size: 17px !important; }
  h3 { font-size: 15px !important; }
</style>

## Overview

SSO is down. Ransomware is spreading throughout your environment. You can't login to CS to isolate hosts. You are a sitting duck. Hold on. Wait. No need to fear, a jank script has appeared.

### PsFalcon 

CrowdStrike has a Powershell Module called PsFalcon.

Installing this module allows for scripts to query the CS API with both read and write requests.

It is available for Python and PowerShell. I choose PowerShell. Why? Well because ```pip install``` is enough to make a grown man cry.

To query this API you need to create a key via CS.

CS Support --> API Keys and Audit --> Create Key

Here you can assign the relevant privileges to your API key. When you create the key you can tick the boxes.

Documentation for what each permission means lives in the PsFalcon Wiki here - https://github.com/CrowdStrike/psfalcon/wiki

After you create your key you will be given a Client ID and Secret ID. 

These two goodies are used to provision a OAuth token to you when you authenticate at the start of this jank script.

To install the PsFalcon module in Powershell run this command with elevated privileges

```Install-Module -Name PSFalcon -Scope CurrentUser```

### Prerequisites

1. Half a brain
2. API Client ID and Secret ID
3. PsFalcon Module installed
4. A Csv file full of malware infected hosts

### How to use

Script should be super simple to use given that the pre-reqs are sorted.

Script has the following functions:
- Isolate Host
- Unisolate Host
- Display Host Details

Steps:
1. Open up script in a PowerShell shell
2. Enter clientID and secretID
3. Select option
4. Select data input method
5. Enter file path or enter hostname
6. Badda Bing Badda Boom (it's done)

### Jank Script

```Import-Module PSFalcon

Write-Host "`n=========================================================="
Write-Host "--==CrowdStrike Bulk Host Network Isolation Script==--"
Write-Host "============================================================"

#Requests user input for CS API Client and Secret ID
$client_id = Read-Host -Prompt "`nClient ID"
$client_secret = Read-Host -Prompt "Secret ID"
Request-FalconToken -ClientId $client_id -ClientSecret $client_secret

#Script options
Write-Host "`nChoose desired action:"
Write-Host "1. Isolate host(s)"
Write-Host "2. Revoke isolation on host(s)"
Write-Host "3. Query host(s) for details"

#Reads in users choice
$choice = Read-Host "`nEnter your choice (1, 2 or 3)"

#Input option
Write-Host "`nChoose data input method:"
Write-Host "1. Manually type hostname"
Write-Host "2. Provide path to .csv file"

#Reads in users choice
$input_method = Read-Host "`nEnter your choice (1 or 2)"

#Initialises $hosts
$hosts = @()
#First option (Manually type)
if ($input_method -eq "1") {
    $host_input = Read-Host -Prompt "Enter Hostname"
    $hosts += $host_input
}

#Second option (.csv file)
elseif ($input_method -eq "2") {
    Write-Host "`nRequirements for the .csv:"
    Write-Host "1. Hostnames must be in column A"
    Write-Host "2. The Hostname list should start at Row 1 (no column title)"
    $file_path = Read-Host -Prompt "`nEnter full path to .csv file"
    if (Test-Path $file_path) {
        $hosts = @()
        $raw_lines = Get-Content -Path $file_path | Select-Object  #-Skip 1
        foreach ($line in $raw_lines) {
            $cleaned = $line.Trim().Trim(',','"')
            if ($cleaned -ne "") {
                $hosts += $cleaned
            }
        }
    } else {
        Write-Host "File does not exist in dir"
        exit
    }
}

#Retrieves host id for each hostname
#Invoke-FalconHostAction requires a host id. Therefore, I have to pull the host ids from the hostname or else I cannot use the isolate/lift containment endpoint.
$host_ids = @()
foreach ($hostname in $hosts) {
    $result = Get-FalconHost -Filter "hostname:'$hostname'"
    if ($result) {
        $host_ids += $result
    } else {
        Write-Warning "Host ID not found for $hostname"
    }
}

Write-Host "`nHosts loaded from CSV:"
$hosts | ForEach-Object { Write-Host $_ }

#Switch statement for three options
#Isolate/Lift Containment and retrieve host details
switch ($choice) {
        "1"{
          foreach ($unique_host in $host_ids) {
            #Isolation
            Invoke-FalconHostAction -Name contain -Id $unique_host
            Write-Host "Host '$unique_host' has been network isolated"
        }
    }
        "2" {
            foreach ($unique_host in $host_ids) {
            #Lift containment
            Invoke-FalconHostAction -Name lift_containment -Id $unique_host
            Write-Host "Host '$unique_host' network connection reinstated"
        }
    }
        "3" {
            foreach ($unique_host in $host_ids) {
            #Displays all host details
            $host_details = Get-FalconHost -Id $unique_host
                if ($host_details) {
                $host_details | Format-List *
                } else {
                Write-Host "No host details found for '$unique_host'"
            }
        }
    }
}```